<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Rentabilidad</title>
  <style>
    :root {
      --bg-color: #f4ece3;
      --card-bg: #fff7ef;
      --accent: #c27d3f;
      --accent-dark: #9b622d;
      --text-color: #3d2f21;
      --muted-text: #6e5a4b;
      --border-radius: 18px;
      --shadow: 0 12px 24px rgba(90, 60, 30, 0.15);
      --shadow-light: 0 4px 12px rgba(90, 60, 30, 0.08);
      --transition: all 0.25s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", "Poppins", "Nunito", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 48px 20px 100px;
      font-size: 15px;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card-bg);
      padding: 32px 28px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 8px;
    }

    header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: -0.01em;
      line-height: 1.2;
    }

    button.primary {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      box-shadow: var(--shadow-light);
      transition: var(--transition);
    }

    button.primary:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    button.primary:active {
      transform: translateY(0);
    }

    section {
      background: var(--card-bg);
      padding: 32px 28px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    section h2 {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.01em;
      line-height: 1.3;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #roiResultsSection .card-grid {
      justify-content: center;
      max-width: 1000px;
      margin: 0 auto;
    }

    section h3 {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 600;
      line-height: 1.4;
    }

    section p {
      margin: 0;
      line-height: 1.7;
      color: var(--muted-text);
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
    }

    .sku-card,
    .cost-card,
    .result-card {
      background: white;
      border-radius: 14px;
      padding: 20px;
      box-shadow: var(--shadow-light);
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
      transition: var(--transition);
    }

    .sku-card:hover,
    .cost-card:hover {
      box-shadow: var(--shadow);
      transform: translateY(-2px);
    }

    .sku-card h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent-dark);
      line-height: 1.3;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(194, 125, 63, 0.1);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.85rem;
      color: var(--accent-dark);
    }

    .sku-actions {
      display: flex;
      gap: 10px;
    }

    .sku-actions button {
      flex: 1;
      background: transparent;
      border: 1px solid rgba(194, 125, 63, 0.3);
      padding: 8px 10px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      color: var(--accent-dark);
      transition: var(--transition);
    }

    .sku-actions button:hover {
      border-color: var(--accent-dark);
      background: rgba(194, 125, 63, 0.08);
    }

    .cost-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .ghost-button {
      background: transparent;
      border: 1px dashed rgba(194, 125, 63, 0.5);
      color: var(--accent-dark);
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .ghost-button:hover {
      border-style: solid;
      background: rgba(194, 125, 63, 0.1);
    }

    .cost-card h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .cost-card .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--muted-text);
    }

    .cost-card .actions {
      display: flex;
      gap: 10px;
      margin-top: auto;
      position: relative;
    }

    .cost-card .actions button {
      flex: 1;
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .cost-card .actions button.edit {
      background: rgba(194, 125, 63, 0.16);
      color: var(--accent-dark);
    }

    .cost-card .actions button.delete {
      background: rgba(179, 55, 39, 0.15);
      color: #9b2d1b;
    }

    .inline-chip {
      background: rgba(0, 0, 0, 0.06);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.8rem;
    }

    .group-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .action-menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow-light);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 10;
      min-width: 200px;
    }

    .action-menu button {
      background: transparent;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: var(--accent-dark);
      text-align: left;
      transition: var(--transition);
    }

    .action-menu button:hover {
      background: rgba(194, 125, 63, 0.12);
    }

    .cost-summary {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--shadow-light);
    }

    .capital-overview {
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(194, 125, 63, 0.08);
      border-radius: 12px;
      padding: 12px 14px;
    }

    .capital-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .capital-row label {
      font-weight: 600;
      color: var(--muted-text);
    }

    .capital-input-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .capital-input-wrapper input[type="number"] {
      max-width: 160px;
      min-width: 120px;
    }

    .capital-amount {
      font-weight: 600;
      color: var(--accent-dark);
    }

    .capital-coverage-message {
      display: none;
      background: rgba(76, 130, 86, 0.18);
      color: #3d6b3b;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
    }

    .checkbox-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .checkbox-list label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      color: var(--muted-text);
    }

    .checkbox-list input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .summary-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .toggle {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }

    .toggle input {
      width: 46px;
      height: 24px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(0, 0, 0, 0.15);
      border-radius: 999px;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .toggle input::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: var(--transition);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }

    .toggle input:checked {
      background: var(--accent);
    }

    .toggle input:checked::after {
      transform: translateX(22px);
    }

    .parameter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      align-items: start;
    }

    .parameter-card {
      background: white;
      border-radius: 12px;
      padding: 18px 20px;
      box-shadow: var(--shadow-light);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .parameter-card label {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-weight: 600;
      color: var(--text-color);
    }

    .parameter-card label span {
      font-size: 0.95rem;
      line-height: 1.4;
    }

    input[type="text"],
    input[type="number"],
    select {
      padding: 12px 14px;
      border: 1.5px solid #e0d0c0;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      background: white;
      transition: var(--transition);
      outline: none;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(194, 125, 63, 0.1);
    }

    input::placeholder {
      color: #b8a89a;
    }

    .mode-selector {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .mode-selector button {
      flex: 1 1 140px;
      background: rgba(194, 125, 63, 0.12);
      border: none;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 600;
      color: var(--accent-dark);
      cursor: pointer;
      transition: var(--transition);
    }

    .mode-selector button.active {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-light);
    }

    .mode-panel {
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    .mode-panel.active {
      display: flex;
    }

    .slider-row {
      display: grid;
      grid-template-columns: 1fr 80px;
      gap: 10px;
      align-items: center;
    }

    .slider-row strong {
      text-align: right;
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }

    .alert {
      background: rgba(179, 55, 39, 0.1);
      color: #8b2b1a;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .result-card h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--accent-dark);
    }

    .result-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .result-body ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .result-body li {
      background: rgba(194, 125, 63, 0.08);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 600;
    }

    .result-body li strong {
      display: block;
    }

    .result-quantity {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
      font-weight: 500;
    }

    .result-quantity-real {
      font-size: 1.05rem;
      color: var(--text-color);
      font-weight: 700;
    }

    .result-quantity-exact {
      font-size: 0.9rem;
      color: var(--muted-text);
    }

    .result-footer {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .result-footer button {
      align-self: flex-start;
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent-dark);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .result-footer button:hover {
      background: var(--accent);
      color: white;
    }

    .warnings {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.95rem;
      color: #8b2b1a;
    }

    .empty-state {
      padding: 18px;
      border-radius: 14px;
      background: rgba(194, 125, 63, 0.12);
      text-align: center;
      font-weight: 600;
      color: var(--accent-dark);
    }

    .collapsible {
      background: rgba(194, 125, 63, 0.08);
      padding: 14px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .collapsible button {
      align-self: flex-start;
      background: transparent;
      border: none;
      color: var(--accent-dark);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .collapsible-content {
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    .collapsible-content.open {
      display: flex;
    }

    .cost-breakdown-card {
      background: white;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: var(--shadow-light);
    }

    .cost-breakdown-card h4 {
      margin: 0 0 6px;
      font-size: 1rem;
      color: var(--accent-dark);
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--accent-dark);
      color: white;
      padding: 12px 18px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events: none;
      transform: translateY(20px);
      transition: var(--transition);
      font-weight: 600;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .cost-group-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      background: rgba(194, 125, 63, 0.08);
      padding: 12px 16px;
      border-radius: 14px;
    }

    .cost-group-bar label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--muted-text);
    }

    .cost-group-bar select {
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(194, 125, 63, 0.35);
      background: white;
      font-size: 0.95rem;
      min-width: 220px;
    }

    .group-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(61, 47, 33, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
      width: min(400px, 100%);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .modal h3 {
      margin: 0;
      font-size: 1.3rem;
      color: var(--accent-dark);
    }

    .modal-message {
      margin: 0;
      color: var(--muted-text);
      font-size: 0.95rem;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .modal-actions button {
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }

    .modal-actions button.cancel {
      background: rgba(0, 0, 0, 0.08);
      color: var(--muted-text);
    }

    .modal-actions button.confirm {
      background: var(--accent);
      color: white;
    }

    @media (max-width: 720px) {
      body {
        padding: 24px 10px 60px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 14px;
      }

      .result-body li {
        font-size: 0.95rem;
      }
    }

    /* Menu Styles */
    .main-menu {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
      padding: 20px;
    }

    .main-menu h1 {
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin: 0;
      text-align: center;
      line-height: 1.2;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 28px;
      width: 100%;
      max-width: 800px;
      margin-bottom: 40px;
    }

    .menu-card {
      background: white;
      border: none;
      border-radius: 20px;
      padding: 44px 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .menu-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 20px 40px rgba(90, 60, 30, 0.25);
    }

    .menu-card .icon {
      font-size: 3.5rem;
      margin-bottom: 8px;
    }

    .menu-card h2 {
      margin: 0;
      color: var(--accent-dark);
      font-size: 1.6rem;
      font-weight: 700;
      line-height: 1.3;
    }

    .menu-card p {
      margin: 0;
      color: var(--muted-text);
      line-height: 1.7;
      font-size: 0.95rem;
    }

    /* Product Mix Inputs in ROI */
    .roi-product-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: white;
      background: transparent;
      padding: 0;
      border-radius: 14px;
      box-shadow: none;
    }

    .roi-product-group {
      background: #faf6f2;
      padding: 20px;
      border-radius: 14px;
      margin-bottom: 16px;
      border: 1px solid rgba(194, 125, 63, 0.12);
      box-shadow: 0 2px 8px rgba(90, 60, 30, 0.04);
    }

    .roi-product-group h4 {
      margin: 0 0 16px 0;
      color: var(--accent-dark);
      font-size: 1.1rem;
      font-weight: 700;
      line-height: 1.3;
    }

    .roi-qty-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
    }

    .roi-qty-item label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted-text);
      margin-bottom: 6px;
    }

    .roi-qty-item input {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid #e0d0c0;
      border-radius: 10px;
      text-align: center;
      font-size: 15px;
      transition: var(--transition);
    }

    .roi-qty-item input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(194, 125, 63, 0.1);
      outline: none;
    }


    .app-nav {
      margin-bottom: 16px;
    }

    .back-btn {
      font-size: 0.9rem;
      padding: 8px 16px;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: rgba(194, 125, 63, 0.2);
      color: var(--accent-dark);
      border-radius: 50%;
      font-size: 0.75rem;
      cursor: help;
      margin-left: 6px;
      position: relative;
    }

    .info-icon:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #3d2f21;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      width: max-content;
      max-width: 250px;
      z-index: 100;
      margin-bottom: 8px;
      box-shadow: var(--shadow);
      font-weight: 400;
      line-height: 1.4;
      text-align: center;
    }

    /* Tabs */
    .roi-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 28px;
      border-bottom: 2px solid rgba(194, 125, 63, 0.12);
      padding-bottom: 12px;
    }

    .roi-tab-btn {
      background: transparent;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      color: var(--muted-text);
      cursor: pointer;
      padding: 10px 20px;
      border-radius: 10px;
      transition: var(--transition);
    }

    .roi-tab-btn:hover {
      background: rgba(194, 125, 63, 0.06);
      color: var(--accent-dark);
    }

    .roi-tab-btn.active {
      background: rgba(194, 125, 63, 0.12);
      color: var(--accent-dark);
    }
  </style>
</head>

<body>
  <div id="main-menu" class="main-menu">
    <h1>Seleccion√° una herramienta</h1>
    <div class="menu-grid">
      <button class="menu-card" id="btnOpenCostApp">
        <div class="icon">üí∞</div>
        <h2>Costos Fijos e Inversiones</h2>
        <p>Gestion√° tus costos fijos, variables y calcul√° precios.</p>
      </button>
      <button class="menu-card" id="btnOpenRoiApp">
        <div class="icon">üìà</div>
        <h2>Calculadora de ROI</h2>
        <p>Proyect√° el retorno de inversi√≥n de tus campa√±as.</p>
      </button>
    </div>

    <!-- Global Products Section -->
    <section id="productsSection" style="width: 100%; max-width: 1200px;">
      <h2>Productos</h2>
      <div class="card-grid" id="productsGrid"></div>
      <div style="margin-top: 16px; text-align: center;">
        <button class="primary" id="addProductBtn">‚ûï Agregar Producto</button>
      </div>
    </section>
  </div>

  <div id="cost-app" class="app-shell" style="display:none;">
    <div class="app-nav">
      <button class="ghost-button back-btn" id="backToMenuFromCost">‚Üê Volver al men√∫</button>
    </div>
    <header>
      <h1>üí∞ Costos Fijos e Inversiones</h1>
      <button class="primary" id="resetDataBtn">Resetear datos</button>
    </header>

    <section id="costsSection">
      <div class="cost-header">
        <h2>Costos a cubrir</h2>
        <button class="ghost-button" id="addCostBtn">Agregar costo</button>
      </div>
      <div class="cost-group-bar">
        <label>
          <span>Cargar grupo</span>
          <select id="costGroupSelect">
            <option value="">Todos los costos</option>
          </select>
        </label>
        <div class="group-actions">
          <button class="ghost-button" id="createGroupBtn" type="button">Crear grupo</button>
          <button class="ghost-button" id="renameGroupBtn" type="button" disabled>Renombrar</button>
          <button class="ghost-button" id="deleteGroupBtn" type="button" disabled>Eliminar</button>
        </div>
      </div>
      <div id="costsList" class="card-grid"></div>
      <div class="cost-summary">
        <div class="capital-overview">
          <div class="capital-row">
            <span>Total prorrateado (<span id="currentPeriodLabel"></span>):</span>
            <strong id="totalCostDisplay">$0,00</strong>
          </div>
          <div class="capital-row">
            <label for="availableCapitalInput">Capital disponible</label>
            <div class="capital-input-wrapper">
              <input type="number" id="availableCapitalInput" min="0" step="0.01" inputmode="decimal" />
              <span class="capital-amount" id="availableCapitalDisplay">$0,00</span>
            </div>
          </div>
          <div class="capital-row">
            <span>Objetivo neto a cubrir:</span>
            <strong id="netTargetDisplay">$0,00</strong>
          </div>
          <div class="capital-coverage-message" id="capitalCoverageMessage" role="status" aria-live="polite">Objetivo
            cubierto: no se requieren ventas</div>
        </div>
        <div class="collapsible">
          <button type="button" id="toggleCostDetail">
            <span id="costDetailToggleLabel">Ver detalle por costo</span>
            <span>‚ñº</span>
          </button>
          <div class="collapsible-content" id="costDetailPanel"></div>
        </div>
      </div>
    </section>

    <section id="parametersSection">
      <h2>Par√°metros de c√°lculo</h2>
      <div class="parameter-grid">
        <div class="parameter-card">
          <label>
            <span>Per√≠odo objetivo</span>
            <select id="periodSelect">
              <option value="diario">Diario</option>
              <option value="semanal">Semanal</option>
              <option value="mensual">Mensual</option>
              <option value="anual">Anual</option>
            </select>
          </label>
        </div>
        <div class="parameter-card">
          <div class="toggle">
            <label for="commissionToggle">Aplicar comisiones</label>
            <input type="checkbox" id="commissionToggle" />
          </div>
          <div id="commissionFields" style="display:none; gap:12px;">
            <label>
              <span>Comisi√≥n variable (%)</span>
              <input type="number" id="commissionPct" min="0" max="20" step="0.1" />
            </label>
            <label>
              <span>Monto fijo por transacci√≥n ($)</span>
              <input type="number" id="commissionFixed" min="0" step="10" />
            </label>
            <!-- Futuro: mix de cobro -->
          </div>
        </div>
      </div>
      <div class="parameter-card">
        <span style="font-weight:600; color: var(--muted-text);">Modo de c√°lculo</span>
        <div class="mode-selector">
          <button type="button" data-mode="single">Producto √∫nico</button>
          <button type="button" data-mode="mix">Mix manual</button>
          <button type="button" data-mode="auto">Opciones autom√°ticas</button>
        </div>
        <div class="mode-panel" data-panel="single">
          <label>
            <span>Seleccion√° un producto</span>
            <select id="singleSkuSelect"></select>
          </label>
          <button class="primary" id="calculateSingleBtn">Calcular unidades</button>
        </div>
        <div class="mode-panel" data-panel="mix">
          <div id="mixSliders" class="mix-sliders"></div>
          <div><strong>Total mix: <span id="mixTotalLabel">0%</span></strong></div>
          <div id="mixWarning" class="alert" style="display:none;">El mix debe sumar 100% para calcular.</div>
          <button class="primary" id="calculateMixBtn">Calcular mix manual</button>
        </div>
        <div class="mode-panel" data-panel="auto">
          <p style="margin:0; color: var(--muted-text);">Generaremos 8 combinaciones diferentes para cubrir el objetivo
            seg√∫n el margen y precio de los productos.</p>
          <button class="primary" id="generateOptionsBtn">Generar opciones</button>
        </div>
      </div>
    </section>

    <section id="resultsSection">
      <h2>Resultados</h2>
      <div id="resultsContainer" class="card-grid"></div>
    </section>
  </div>

  <div id="roi-app" class="app-shell" style="display:none;">
    <div class="app-nav">
      <button class="ghost-button back-btn" id="backToMenuFromRoi">‚Üê Volver al men√∫</button>
    </div>
    <header>
      <h1>üìà Calculadora de ROI</h1>
      <button class="primary" id="resetRoiBtn">Resetear c√°lculo</button>
    </header>

    <section>
      <div class="roi-tabs">
        <button class="roi-tab-btn active" data-tab="real">Modo Resultados Reales</button>
        <button class="roi-tab-btn" data-tab="projection">Modo Proyecci√≥n</button>
      </div>

      <div id="roiProjectionInputs" style="display:none;">
        <h2>Datos de campa√±a (WhatsApp Funnel)</h2>
        <div class="parameter-grid">
          <div class="parameter-card">
            <label>
              <span>Inversi√≥n Total ($) <span class="info-icon"
                  data-tooltip="Tu presupuesto total para la campa√±a publicitaria.">‚ÑπÔ∏è</span></span>
              <input type="number" id="roiBudget" min="0" step="1000" placeholder="Ej: 100000" />
            </label>
          </div>
          <div class="parameter-card">
            <label>
              <span>CPM Estimado ($) <span class="info-icon"
                  data-tooltip="Costo por Mil Impresiones. Cu√°nto te cobra Facebook por mostrar tu anuncio 1000 veces.">‚ÑπÔ∏è</span></span>
              <input type="number" id="roiCpm" min="0" step="100" placeholder="Ej: 2000" />
            </label>
          </div>
          <div class="parameter-card">
            <label>
              <span>CTR Estimado (%) <span class="info-icon"
                  data-tooltip="Click Through Rate. Porcentaje de personas que ven tu anuncio y hacen clic para enviarte un mensaje.">‚ÑπÔ∏è</span></span>
              <input type="number" id="roiCtr" min="0" max="100" step="0.1" placeholder="Ej: 1.5" />
            </label>
          </div>
          <div class="parameter-card">
            <label>
              <span>Tasa de Cierre (%) <span class="info-icon"
                  data-tooltip="De cada 100 personas que te escriben a WhatsApp, ¬øa cu√°ntas logr√°s venderles?">‚ÑπÔ∏è</span></span>
              <input type="number" id="roiConvRate" min="0" max="100" step="0.1" placeholder="Ej: 5.0" />
            </label>
          </div>
          <div class="parameter-card">
            <label>
              <span>Ticket Promedio ($) <span class="info-icon"
                  data-tooltip="El valor promedio de cada venta que cerr√°s.">‚ÑπÔ∏è</span></span>
              <input type="number" id="roiAov" min="0" step="100" placeholder="Ej: 25000" />
            </label>
          </div>
          <div class="parameter-card">
            <label>
              <span>Margen Promedio (%) <span class="info-icon"
                  data-tooltip="Tu ganancia real sobre el precio de venta (descontando costo de producto).">‚ÑπÔ∏è</span></span>
              <input type="number" id="roiMargin" min="0" max="100" step="1" placeholder="Ej: 40" />
            </label>
          </div>
        </div>
      </div>

      <div id="roiRealInputs">
        <h2>Resultados Reales</h2>
        <div class="parameter-grid">
          <div class="parameter-card">
            <label>
              <span>Inversi√≥n Real en Ads ($) <span class="info-icon"
                  data-tooltip="Lo que gastaste finalmente en publicidad.">‚ÑπÔ∏è</span></span>
              <input type="number" id="roiRealBudget" min="0" step="1000" placeholder="Ej: 100000" />
            </label>
          </div>
        </div>

        <div style="margin-top: 24px;">
          <h3 style="font-size: 1.15rem; color: var(--accent-dark); margin-bottom: 16px;">Productos Vendidos</h3>
          <p style="font-size: 0.9rem; color: var(--muted-text); margin-bottom: 16px;">Ingres√° la cantidad de productos
            vendidos (permite decimales, ej: 3.5 para 350 unidades).</p>
          <div id="roiProductInputs"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
            <!-- Dynamic product inputs -->
          </div>
        </div>
      </div>

      <div style="margin-top: 24px; display: flex; justify-content: flex-end;">
        <button class="primary" id="calculateRoiBtn">Calcular Resultados</button>
      </div>
    </section>

    <section id="roiResultsSection" style="display:none;">
      <h2>Resultados</h2>
      <div class="card-grid">
        <div class="result-card" id="cardFunnel">
          <h3>Embudo de Tr√°fico</h3>
          <div class="result-body">
            <ul>
              <li><strong>Impresiones:</strong> <span id="resImpressions">-</span></li>
              <li><strong>Mensajes Nuevos:</strong> <span id="resClicks">-</span></li>
              <li><strong>Costo por Mensaje:</strong> <span id="resCpc">-</span></li>
            </ul>
          </div>
        </div>
        <div class="result-card" id="cardSales">
          <h3>Ventas</h3>
          <div class="result-body">
            <ul>
              <li><strong>Ventas estimadas:</strong> <span id="resConversions">-</span></li>
              <li><strong>CPA (Costo p/venta):</strong> <span id="resCpa">-</span></li>
              <li><strong>Tasa de Cierre:</strong> <span id="resGlobalConv">-</span></li>
            </ul>
          </div>
        </div>
        <div class="result-card">
          <h3>Rentabilidad</h3>
          <div class="result-body">
            <ul>
              <li><strong>Facturaci√≥n Total:</strong> <span id="resRevenue" class="result-quantity-real">-</span></li>
              <li><strong>Costo Ads:</strong> <span id="resAdCost">-</span></li>
              <li><strong>Costo Mercader√≠a:</strong> <span id="resCogs">-</span></li>
              <li><strong>Utilidad Neta:</strong> <span id="resProfit" class="result-quantity-real"
                  style="color:var(--accent-dark);">-</span> <span class="info-icon"
                  data-tooltip="Dinero real que te queda en el bolsillo (Ventas - Ads - Costo Producto).">‚ÑπÔ∏è</span></li>
            </ul>
          </div>
        </div>
        <div class="result-card" style="background: var(--accent); color: white;">
          <h3 style="color: white;">M√©tricas Clave</h3>
          <div class="result-body">
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div>
                <span style="opacity: 0.9; font-size: 0.9rem;">ROAS (Retorno Ads) <span class="info-icon"
                    data-tooltip="Por cada $1 puesto en publicidad, cu√°ntos $ de venta bruta entraron."
                    style="color:white; background:rgba(255,255,255,0.2);">‚ÑπÔ∏è</span></span>
                <strong style="font-size: 1.8rem; display: block;" id="resRoas">-</strong>
              </div>
              <div>
                <span style="opacity: 0.9; font-size: 0.9rem;">ROI (Retorno Inversi√≥n) <span class="info-icon"
                    data-tooltip="Rentabilidad real de tu inversi√≥n total (incluyendo costo de mercader√≠a)."
                    style="color:white; background:rgba(255,255,255,0.2);">‚ÑπÔ∏è</span></span>
                <strong style="font-size: 1.8rem; display: block;" id="resRoi">-</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="modal-root"></div>

  <div class="toast" id="toast"></div>

  <script>
    (function () {
      const SCHEMA_VERSION = 1;
      const STORAGE_KEY = 'rentabilidad_app_state_v1';
      const PERIOD_LABELS = { diario: 'Diario', semanal: 'Semanal', mensual: 'Mensual', anual: 'Anual' };
      const PERIOD_CONVERSION = {
        diario: { diario: 1, semanal: 7, mensual: 30, anual: 365 },
        semanal: { diario: 1 / 7, semanal: 1, mensual: 4.345, anual: 52 },
        mensual: { diario: 1 / 30, semanal: 1 / 4.345, mensual: 1, anual: 12 },
        anual: { diario: 1 / 365, semanal: 1 / 52, mensual: 1 / 12, anual: 1 }
      };

      const DEFAULT_PRODUCTS = [
        { id: 'sku_28_maicena', name: '100 uni. de 28mm Maicena', pricePer100: 22000, costPer100: 7234, unitsPerBox: 100, description: '1 caja de 100 unidades.' },
        { id: 'sku_28_chocolate', name: '100 uni. de 28mm Chocolate', pricePer100: 23000, costPer100: 7307, unitsPerBox: 100, description: '1 caja de 100 unidades.' },
        { id: 'sku_44_maicena', name: '100 uni. de 44mm Maicena', pricePer100: 32500, costPer100: 13356, unitsPerBox: 50, description: '2 cajas de 50 unidades.' },
        { id: 'sku_44_chocolate', name: '100 uni. de 44mm Chocolate', pricePer100: 34000, costPer100: 13560, unitsPerBox: 50, description: '2 cajas de 50 unidades.' }
      ];

      const currencyFormatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2 });
      const numberFormatter = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const integerFormatter = new Intl.NumberFormat('es-AR', { maximumFractionDigits: 0 });

      let state = loadState();
      let lastResults = [];
      let toastTimeout = null;
      let activeActionMenuCleanup = null;

      const modalRoot = ensureModalRoot();

      function ensureModalRoot() {
        let root = document.getElementById('modal-root');
        if (!root) {
          root = document.createElement('div');
          root.id = 'modal-root';
          document.body.appendChild(root);
        }
        return root;
      }

      function getFocusableElements(container) {
        const selectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
        return Array.from(container.querySelectorAll(selectors)).filter((element) => {
          return !element.disabled && element.getAttribute('aria-hidden') !== 'true' && element.tabIndex !== -1;
        });
      }

      function trapFocus(event, container) {
        if (event.key !== 'Tab') return;
        const focusable = getFocusableElements(container);
        if (!focusable.length) {
          event.preventDefault();
          return;
        }
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (focusable.length === 1) {
          event.preventDefault();
          first.focus();
          return;
        }
        if (event.shiftKey) {
          if (document.activeElement === first) {
            event.preventDefault();
            last.focus();
          }
        } else if (document.activeElement === last) {
          event.preventDefault();
          first.focus();
        }
      }

      async function openAlertModal({ title, message }) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.className = 'modal-overlay';
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.setAttribute('role', 'dialog');
          modal.setAttribute('aria-modal', 'true');

          const heading = document.createElement('h3');
          heading.textContent = title;
          const body = document.createElement('p');
          body.className = 'modal-message';
          body.textContent = message;
          const actions = document.createElement('div');
          actions.className = 'modal-actions';
          const confirmButton = document.createElement('button');
          confirmButton.className = 'confirm';
          confirmButton.type = 'button';
          confirmButton.textContent = 'Aceptar';
          actions.appendChild(confirmButton);

          modal.appendChild(heading);
          modal.appendChild(body);
          modal.appendChild(actions);
          overlay.appendChild(modal);
          modalRoot.appendChild(overlay);

          const focusTarget = getFocusableElements(modal)[0] || confirmButton;
          setTimeout(() => focusTarget.focus(), 0);

          const cleanup = () => {
            overlay.removeEventListener('click', handleOverlayClick);
            overlay.removeEventListener('keydown', handleKeyDown);
            confirmButton.removeEventListener('click', handleConfirm);
            if (overlay.parentNode) {
              overlay.parentNode.removeChild(overlay);
            }
          };

          const handleConfirm = () => {
            cleanup();
            resolve();
          };

          const handleOverlayClick = (event) => {
            if (event.target === overlay) {
              handleConfirm();
            }
          };

          const handleKeyDown = (event) => {
            if (event.key === 'Escape') {
              event.preventDefault();
              handleConfirm();
              return;
            }
            if (event.key === 'Enter' && document.activeElement === confirmButton) {
              event.preventDefault();
              handleConfirm();
              return;
            }
            trapFocus(event, modal);
          };

          overlay.addEventListener('click', handleOverlayClick);
          overlay.addEventListener('keydown', handleKeyDown);
          confirmButton.addEventListener('click', handleConfirm);
        });
      }

      async function openConfirmModal({ title, message, confirmText = 'Confirmar', cancelText = 'Cancelar' }) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.className = 'modal-overlay';
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.setAttribute('role', 'dialog');
          modal.setAttribute('aria-modal', 'true');

          const heading = document.createElement('h3');
          heading.textContent = title;
          const body = document.createElement('p');
          body.className = 'modal-message';
          body.textContent = message;
          const actions = document.createElement('div');
          actions.className = 'modal-actions';
          const cancelButton = document.createElement('button');
          cancelButton.className = 'cancel';
          cancelButton.type = 'button';
          cancelButton.textContent = cancelText;
          const confirmButton = document.createElement('button');
          confirmButton.className = 'confirm';
          confirmButton.type = 'button';
          confirmButton.textContent = confirmText;
          actions.appendChild(cancelButton);
          actions.appendChild(confirmButton);

          modal.appendChild(heading);
          modal.appendChild(body);
          modal.appendChild(actions);
          overlay.appendChild(modal);
          modalRoot.appendChild(overlay);

          const focusTarget = getFocusableElements(modal)[0] || cancelButton;
          setTimeout(() => focusTarget.focus(), 0);

          const cleanup = () => {
            overlay.removeEventListener('click', handleOverlayClick);
            overlay.removeEventListener('keydown', handleKeyDown);
            cancelButton.removeEventListener('click', handleCancel);
            confirmButton.removeEventListener('click', handleConfirm);
            if (overlay.parentNode) {
              overlay.parentNode.removeChild(overlay);
            }
          };

          const handleCancel = () => {
            cleanup();
            resolve(false);
          };

          const handleConfirm = () => {
            cleanup();
            resolve(true);
          };

          const handleOverlayClick = (event) => {
            if (event.target === overlay) {
              handleCancel();
            }
          };

          const handleKeyDown = (event) => {
            if (event.key === 'Escape') {
              event.preventDefault();
              handleCancel();
              return;
            }
            trapFocus(event, modal);
          };

          overlay.addEventListener('click', handleOverlayClick);
          overlay.addEventListener('keydown', handleKeyDown);
          cancelButton.addEventListener('click', handleCancel);
          confirmButton.addEventListener('click', handleConfirm);
        });
      }

      async function openPromptModal({ title, label, placeholder = '', initialValue = '', confirmText = 'Aceptar', cancelText = 'Cancelar' }) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.className = 'modal-overlay';
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.setAttribute('role', 'dialog');
          modal.setAttribute('aria-modal', 'true');

          const heading = document.createElement('h3');
          heading.textContent = title;
          const body = document.createElement('div');
          body.className = 'modal-body';
          const promptLabel = document.createElement('label');
          const labelSpan = document.createElement('span');
          labelSpan.textContent = label;
          const input = document.createElement('input');
          input.type = 'text';
          input.value = initialValue;
          input.placeholder = placeholder;
          promptLabel.appendChild(labelSpan);
          promptLabel.appendChild(input);
          body.appendChild(promptLabel);
          const actions = document.createElement('div');
          actions.className = 'modal-actions';
          const cancelButton = document.createElement('button');
          cancelButton.className = 'cancel';
          cancelButton.type = 'button';
          cancelButton.textContent = cancelText;
          const confirmButton = document.createElement('button');
          confirmButton.className = 'confirm';
          confirmButton.type = 'button';
          confirmButton.textContent = confirmText;
          actions.appendChild(cancelButton);
          actions.appendChild(confirmButton);

          modal.appendChild(heading);
          modal.appendChild(body);
          modal.appendChild(actions);
          overlay.appendChild(modal);
          modalRoot.appendChild(overlay);

          setTimeout(() => input.focus(), 0);

          const cleanup = () => {
            overlay.removeEventListener('click', handleOverlayClick);
            overlay.removeEventListener('keydown', handleKeyDown);
            cancelButton.removeEventListener('click', handleCancel);
            confirmButton.removeEventListener('click', handleConfirm);
            if (overlay.parentNode) {
              overlay.parentNode.removeChild(overlay);
            }
          };

          const handleCancel = () => {
            cleanup();
            resolve(null);
          };

          const handleConfirm = () => {
            cleanup();
            resolve(input.value);
          };

          const handleOverlayClick = (event) => {
            if (event.target === overlay) {
              handleCancel();
            }
          };

          const handleKeyDown = (event) => {
            if (event.key === 'Escape') {
              event.preventDefault();
              handleCancel();
              return;
            }
            if (event.key === 'Enter' && !event.shiftKey && document.activeElement === input) {
              event.preventDefault();
              handleConfirm();
              return;
            }
            trapFocus(event, modal);
          };

          overlay.addEventListener('click', handleOverlayClick);
          overlay.addEventListener('keydown', handleKeyDown);
          cancelButton.addEventListener('click', handleCancel);
          confirmButton.addEventListener('click', handleConfirm);
        });
      }

      const elements = {
        productsGrid: document.getElementById('productsGrid'),
        costsList: document.getElementById('costsList'),
        periodSelect: document.getElementById('periodSelect'),
        commissionToggle: document.getElementById('commissionToggle'),
        commissionFields: document.getElementById('commissionFields'),
        commissionPct: document.getElementById('commissionPct'),
        commissionFixed: document.getElementById('commissionFixed'),
        resultsContainer: document.getElementById('resultsContainer'),
        singleSkuSelect: document.getElementById('singleSkuSelect'),
        mixSliders: document.getElementById('mixSliders'),
        mixTotalLabel: document.getElementById('mixTotalLabel'),
        mixWarning: document.getElementById('mixWarning'),
        calculateSingleBtn: document.getElementById('calculateSingleBtn'),
        calculateMixBtn: document.getElementById('calculateMixBtn'),
        generateOptionsBtn: document.getElementById('generateOptionsBtn'),
        costGroupSelect: document.getElementById('costGroupSelect'),
        createGroupBtn: document.getElementById('createGroupBtn'),
        renameGroupBtn: document.getElementById('renameGroupBtn'),
        deleteGroupBtn: document.getElementById('deleteGroupBtn'),
        totalCostDisplay: document.getElementById('totalCostDisplay'),
        availableCapitalInput: document.getElementById('availableCapitalInput'),
        availableCapitalDisplay: document.getElementById('availableCapitalDisplay'),
        netTargetDisplay: document.getElementById('netTargetDisplay'),
        capitalCoverageMessage: document.getElementById('capitalCoverageMessage'),
        currentPeriodLabel: document.getElementById('currentPeriodLabel'),
        costDetailPanel: document.getElementById('costDetailPanel'),
        costDetailToggle: document.getElementById('toggleCostDetail'),
        costDetailToggleLabel: document.getElementById('costDetailToggleLabel'),
        toast: document.getElementById('toast')
      };

      initApp();

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return getDefaultState();
          const parsed = JSON.parse(raw);
          if (parsed.version !== SCHEMA_VERSION) return getDefaultState();
          const merged = Object.assign({}, getDefaultState(), parsed);

          // Load products but force update metadata for default products
          const loadedProducts = Array.isArray(parsed.products) && parsed.products.length ? parsed.products.map(copyProduct) : DEFAULT_PRODUCTS.map(copyProduct);

          merged.products = loadedProducts.map(p => {
            const def = DEFAULT_PRODUCTS.find(d => d.id === p.id);
            if (def) {
              // Update metadata (name, description, unitsPerBox) but keep user pricing/cost if exists
              p.name = def.name;
              p.description = def.description;
              p.unitsPerBox = def.unitsPerBox;
            }
            return p;
          });

          merged.costs = Array.isArray(parsed.costs) ? parsed.costs.map(copyCost).filter(Boolean) : [];
          merged.costGroups = Array.isArray(parsed.costGroups) ? parsed.costGroups.map(copyCostGroup).filter(Boolean) : [];
          merged.activeCostGroupId = parsed.activeCostGroupId && merged.costGroups.some(group => group.id === parsed.activeCostGroupId) ? parsed.activeCostGroupId : null;
          merged.settings = Object.assign({}, getDefaultState().settings, parsed.settings || {});
          merged.settings.availableCapital = Math.max(0, parseFloat(merged.settings.availableCapital) || 0);
          ensureMixCompleteness(merged);
          return merged;
        } catch (error) {
          console.error('No se pudo cargar el estado, se usar√° la configuraci√≥n por defecto.', error);
          return getDefaultState();
        }
      }


      function getDefaultState() {
        const mix = {};
        const base = Math.floor(100 / DEFAULT_PRODUCTS.length);
        let remainder = 100 - base * DEFAULT_PRODUCTS.length;
        DEFAULT_PRODUCTS.forEach((product) => {
          let value = base;
          if (remainder > 0) {
            value += 1;
            remainder -= 1;
          }
          mix[product.id] = value;
        });
        return {
          version: SCHEMA_VERSION,
          products: DEFAULT_PRODUCTS.map(copyProduct),
          costs: [],
          costGroups: [],
          activeCostGroupId: null,
          settings: {
            period: 'mensual',
            commissions: { enabled: false, pct: 0, fixed: 0 },
            mode: 'single',
            selectedSkuId: DEFAULT_PRODUCTS[0].id,
            availableCapital: 0,
            mix
          }
        };
      }

      function ensureMixCompleteness(currentState) {
        const mix = Object.assign({}, currentState.settings.mix || {});
        currentState.products.forEach((product) => {
          if (typeof mix[product.id] !== 'number') mix[product.id] = 0;
        });
        currentState.settings.mix = mix;
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function copyProduct(product) {
        return Object.assign({}, product);
      }

      function copyCost(cost) {
        if (!cost) return null;
        const cloned = Object.assign({}, cost);
        if (Array.isArray(cloned.groupIds)) {
          cloned.groupIds = cloned.groupIds.filter((id) => typeof id === 'string' && id);
        } else if (cloned.groupId) {
          cloned.groupIds = [cloned.groupId];
        } else {
          cloned.groupIds = [];
        }
        delete cloned.groupId;
        return cloned;
      }

      function copyCostGroup(group) {
        if (!group || !group.id) return null;
        return { id: group.id, name: group.name || 'Grupo sin nombre' };
      }

      function init() {
        bindEvents();
        renderParameters();
        renderProducts();
        renderGroupControls();
        renderCosts();
        updateModeButtons();
        updateModePanels();
        updateCostSummary();
        renderResults([]);
      }

      function bindEvents() {
        document.getElementById('resetDataBtn').addEventListener('click', handleReset);
        document.getElementById('addCostBtn').addEventListener('click', () => openCostModal());
        elements.periodSelect.addEventListener('change', (ev) => {
          state.settings.period = ev.target.value;
          saveState();
          updateCostSummary();
        });
        elements.commissionToggle.addEventListener('change', (ev) => {
          state.settings.commissions.enabled = ev.target.checked;
          elements.commissionFields.style.display = ev.target.checked ? 'flex' : 'none';
          saveState();
        });
        elements.commissionPct.addEventListener('input', (ev) => {
          state.settings.commissions.pct = parseFloat(ev.target.value) || 0;
          saveState();
        });
        elements.commissionFixed.addEventListener('input', (ev) => {
          state.settings.commissions.fixed = parseFloat(ev.target.value) || 0;
          saveState();
        });
        elements.costGroupSelect.addEventListener('change', (ev) => {
          const groupId = ev.target.value || null;
          state.activeCostGroupId = groupId;
          saveState();
          renderCosts();
          updateCostSummary();
          renderResults([]);
          renderGroupControls();
        });
        elements.createGroupBtn.addEventListener('click', handleCreateGroup);
        elements.renameGroupBtn.addEventListener('click', handleRenameGroup);
        elements.deleteGroupBtn.addEventListener('click', handleDeleteGroup);
        elements.calculateSingleBtn.addEventListener('click', handleSingleCalculation);
        elements.calculateMixBtn.addEventListener('click', handleMixCalculation);
        elements.generateOptionsBtn.addEventListener('click', handleGenerateOptions);
        elements.costDetailToggle.addEventListener('click', toggleCostDetailPanel);
        if (elements.availableCapitalInput) {
          elements.availableCapitalInput.addEventListener('input', handleAvailableCapitalChange);
          elements.availableCapitalInput.addEventListener('blur', normalizeAvailableCapitalInput);
        }
        document.querySelectorAll('.mode-selector button').forEach((button) => {
          button.addEventListener('click', () => {
            state.settings.mode = button.dataset.mode;
            saveState();
            updateModeButtons();
            updateModePanels();
          });
        });
      }

      async function handleReset() {
        const confirmed = await openConfirmModal({
          title: 'Resetear datos',
          message: '¬øSeguro que quer√©s borrar todos los datos guardados?',
          confirmText: 'Borrar todo',
          cancelText: 'Cancelar'
        }); // REPLACED: native dialog ‚Üí internal modal
        if (!confirmed) return;
        localStorage.removeItem(STORAGE_KEY);
        state = getDefaultState();
        lastResults = [];
        renderParameters();
        renderProducts();
        renderGroupControls();
        renderCosts();
        updateModeButtons();
        updateModePanels();
        updateCostSummary();
        renderResults([]);
        showToast('Datos restaurados');
      }

      function renderParameters() {
        if (!PERIOD_LABELS[state.settings.period]) {
          state.settings.period = 'mensual';
        }
        elements.periodSelect.value = state.settings.period;
        elements.commissionToggle.checked = !!state.settings.commissions.enabled;
        elements.commissionFields.style.display = state.settings.commissions.enabled ? 'flex' : 'none';
        elements.commissionPct.value = state.settings.commissions.pct || 0;
        elements.commissionFixed.value = state.settings.commissions.fixed || 0;
      }

      function renderProducts() {
        elements.productsGrid.innerHTML = '';
        state.products.forEach((product) => {
          const marginInfo = calculateMargins(product);
          const card = document.createElement('div');
          card.className = 'sku-card';
          card.innerHTML = `
            <div>
              <h3>${product.name}</h3>
              <div class="tag">Margen actual: ${numberFormatter.format(marginInfo.marginPct * 100)}%</div>
            </div>
            <div>
              <div>Precio por producto: <strong>${currencyFormatter.format(product.pricePer100)}</strong></div>
              <div>Costo por producto: <strong>${currencyFormatter.format(product.costPer100)}</strong></div>
            </div>
            <p style="margin:0; color: var(--muted-text);">${product.description}</p>
            <div class="sku-actions">
              <button data-action="edit" data-id="${product.id}">‚úèÔ∏è Editar</button>
              <button data-action="delete" data-id="${product.id}">üóëÔ∏è Eliminar</button>
            </div>
          `;
          card.querySelectorAll('button').forEach((btn) => {
            btn.addEventListener('click', () => {
              if (btn.dataset.action === 'edit') {
                openProductModal(product);
              } else if (btn.dataset.action === 'delete') {
                handleDeleteProduct(btn.dataset.id);
              }
            });
          });
          elements.productsGrid.appendChild(card);
        });
        populateSingleSkuSelect();
        renderMixSliders();
        renderRoiProductInputs();
      }

      function calculateMargins(product) {
        const pricing = buildPricing(product);
        const marginUnit = pricing.netUnit - pricing.costUnit;
        const marginPct = pricing.netUnit > 0 ? marginUnit / pricing.netUnit : 0;
        return { marginUnit, marginPct };
      }

      function buildPricing(product) {
        const priceUnit = product.pricePer100 / 100;
        const costUnit = product.costPer100 / 100;
        let netUnit = priceUnit;
        if (state.settings.commissions.enabled) {
          const pct = (state.settings.commissions.pct || 0) / 100;
          const fixed = (state.settings.commissions.fixed || 0) / 100;
          netUnit = priceUnit - (priceUnit * pct) - fixed;
        }
        return { priceUnit, costUnit, netUnit };
      }

      async function openProductModal(existingProduct = null) {
        const isEdit = Boolean(existingProduct);
        const product = existingProduct || { id: '', name: '', description: '', pricePer100: 0, costPer100: 0, unitsPerBox: 100 };

        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.setAttribute('role', 'dialog');
        modal.setAttribute('aria-modal', 'true');

        const heading = document.createElement('h3');
        heading.textContent = isEdit ? 'Editar Producto' : 'Agregar Producto';

        const body = document.createElement('div');
        body.className = 'modal-body';
        body.innerHTML = `
          <label>
            <span>Nombre del producto</span>
            <input type="text" id="productName" value="${product.name}" placeholder="Ej: 100u 28mm Maicena" />
          </label>
          <label>
            <span>Descripci√≥n</span>
            <input type="text" id="productDesc" value="${product.description}" placeholder="Ej: Empaque: 1 caja de 100 unidades" />
          </label>
          <label>
            <span>Precio por producto ($)</span>
            <input type="number" id="productPrice" value="${product.pricePer100}" min="0" step="100" />
          </label>
          <label>
            <span>Costo por producto ($)</span>
            <input type="number" id="productCost" value="${product.costPer100}" min="0" step="100" />
          </label>
          <label>
            <span>Unidades por caja (para Cost Calculator)</span>
            <input type="number" id="productUnitsPerBox" value="${product.unitsPerBox}" min="1" step="1" />
          </label>
        `;

        const actions = document.createElement('div');
        actions.className = 'modal-actions';
        const cancelButton = document.createElement('button');
        cancelButton.className = 'cancel';
        cancelButton.textContent = 'Cancelar';
        const confirmButton = document.createElement('button');
        confirmButton.className = 'confirm';
        confirmButton.textContent = isEdit ? 'Guardar' : 'Agregar';
        actions.appendChild(cancelButton);
        actions.appendChild(confirmButton);

        modal.appendChild(heading);
        modal.appendChild(body);
        modal.appendChild(actions);
        overlay.appendChild(modal);
        document.getElementById('modal-root').appendChild(overlay);

        const inputs = {
          name: document.getElementById('productName'),
          description: document.getElementById('productDesc'),
          price: document.getElementById('productPrice'),
          cost: document.getElementById('productCost'),
          unitsPerBox: document.getElementById('productUnitsPerBox')
        };

        const close = () => document.getElementById('modal-root').removeChild(overlay);

        cancelButton.addEventListener('click', close);
        confirmButton.addEventListener('click', async () => {
          const name = inputs.name.value.trim();
          const description = inputs.description.value.trim();
          const price = parseFloat(inputs.price.value);
          const cost = parseFloat(inputs.cost.value);
          const unitsPerBox = parseInt(inputs.unitsPerBox.value);

          if (!name || !description) {
            await openAlertModal({ title: 'Datos incompletos', message: 'Complet√° el nombre y la descripci√≥n.' });
            return;
          }
          if (isNaN(price) || price <= 0 || isNaN(cost) || cost <= 0) {
            await openAlertModal({ title: 'Valores inv√°lidos', message: 'El precio y costo deben ser mayores a 0.' });
            return;
          }
          if (isNaN(unitsPerBox) || unitsPerBox <= 0) {
            await openAlertModal({ title: 'Valor inv√°lido', message: 'Las unidades por caja deben ser mayores a 0.' });
            return;
          }

          if (isEdit) {
            // Update existing product
            product.name = name;
            product.description = description;
            product.pricePer100 = price;
            product.costPer100 = cost;
            product.unitsPerBox = unitsPerBox;
          } else {
            // Add new product
            const newProduct = {
              id: 'sku_' + Date.now(),
              name,
              description,
              pricePer100: price,
              costPer100: cost,
              unitsPerBox
            };
            state.products.push(newProduct);
            state.settings.mix[newProduct.id] = 0; // Initialize mix to 0
          }

          saveState();
          renderProducts();
          updateCostSummary();
          showToast(isEdit ? 'Producto actualizado' : 'Producto agregado');
          close();
        });
      }

      async function handleDeleteProduct(productId) {
        const product = state.products.find(p => p.id === productId);
        if (!product) return;

        const confirmed = await openConfirmModal({
          title: 'Eliminar producto',
          message: `¬øEst√°s seguro de eliminar "${product.name}"? Esta acci√≥n no se puede deshacer.`,
          confirmText: 'Eliminar',
          cancelText: 'Cancelar'
        });

        if (!confirmed) return;

        // Remove product
        state.products = state.products.filter(p => p.id !== productId);
        delete state.settings.mix[productId];

        // If it was the selected SKU, select the first one
        if (state.settings.selectedSkuId === productId && state.products.length > 0) {
          state.settings.selectedSkuId = state.products[0].id;
        }

        saveState();
        renderProducts();
        updateCostSummary();
        showToast('Producto eliminado');
      }

      function openValueModal({ title, label, value, min, step, onConfirm }) {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.innerHTML = `
          <div class="modal" role="dialog" aria-modal="true">
            <h3>${title}</h3>
            <label>
              <span>${label}</span>
              <input type="number" id="modalInput" value="${value}" min="${min ?? 0}" step="${step ?? 0.01}" />
            </label>
            <div class="modal-actions">
              <button class="cancel">Cancelar</button>
              <button class="confirm">Guardar</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
        const input = overlay.querySelector('#modalInput');
        setTimeout(() => input.focus(), 60);
        const close = () => document.body.removeChild(overlay);
        overlay.addEventListener('click', (event) => {
          if (event.target === overlay) close();
        });
        overlay.querySelector('.cancel').addEventListener('click', close);
        overlay.querySelector('.confirm').addEventListener('click', async () => {
          const accepted = await onConfirm(input.value);
          if (accepted !== false) close();
        });
      }

      function populateSingleSkuSelect() {
        const select = elements.singleSkuSelect;
        select.innerHTML = '';
        state.products.forEach((product) => {
          const option = document.createElement('option');
          option.value = product.id;
          option.textContent = product.name;
          select.appendChild(option);
        });
        select.value = state.settings.selectedSkuId;
        select.onchange = (ev) => {
          state.settings.selectedSkuId = ev.target.value;
          saveState();
        };
      }

      function renderMixSliders() {
        elements.mixSliders.innerHTML = '';
        const mix = state.settings.mix || {};
        state.products.forEach((product) => {
          const value = mix[product.id] ?? 0;
          const wrapper = document.createElement('div');
          wrapper.className = 'slider-row';
          wrapper.innerHTML = `
            <div>
              <label>
                <span>${product.name}</span>
                <input type="range" min="0" max="100" step="1" value="${value}" data-id="${product.id}" />
              </label>
            </div>
            <strong><span data-range-label="${product.id}">${value}</span>%</strong>
          `;
          elements.mixSliders.appendChild(wrapper);
        });
        elements.mixSliders.querySelectorAll('input[type="range"]').forEach((slider) => {
          slider.addEventListener('input', () => {
            const id = slider.dataset.id;
            const val = parseInt(slider.value, 10) || 0;
            state.settings.mix[id] = val;
            const label = elements.mixSliders.querySelector(`[data-range-label="${id}"]`);
            if (label) label.textContent = val;
            updateMixTotal();
            saveState();
          });
        });
        updateMixTotal();
      }

      function updateMixTotal() {
        const total = state.products.reduce((acc, product) => acc + (state.settings.mix[product.id] || 0), 0);
        elements.mixTotalLabel.textContent = total + '%';
        const withinTolerance = Math.abs(total - 100) <= 0.5;
        elements.mixWarning.style.display = withinTolerance ? 'none' : 'block';
        elements.calculateMixBtn.disabled = !withinTolerance;
        elements.calculateMixBtn.style.opacity = withinTolerance ? '1' : '0.6';
      }

      function getActiveCosts() {
        if (!state.activeCostGroupId) return state.costs.slice();
        return state.costs.filter(cost => Array.isArray(cost.groupIds) && cost.groupIds.includes(state.activeCostGroupId));
      }

      function renderCosts() {
        const list = elements.costsList;
        list.innerHTML = '';
        if (activeActionMenuCleanup) {
          activeActionMenuCleanup();
          activeActionMenuCleanup = null;
        }
        const costs = getActiveCosts();
        if (!costs.length) {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.textContent = state.activeCostGroupId ? 'Este grupo no tiene costos cargados todav√≠a.' : 'Todav√≠a no cargaste costos. Agreg√° uno para comenzar.';
          list.appendChild(empty);
          return;
        }
        const activePeriodLabel = (PERIOD_LABELS[state.settings.period] || 'Seleccionado').toLowerCase();
        costs.forEach((cost) => {
          const card = document.createElement('div');
          card.className = 'cost-card';
          const title = document.createElement('h3');
          title.textContent = cost.name;
          card.appendChild(title);

          const amountText = currencyFormatter.format(cost.amount);
          const amortizationText = cost.type === 'inversion' ? `Amortiza en ${cost.amortization || 1} per√≠odos` : 'Fijo recurrente';
          const prorated = currencyFormatter.format(prorateCostAmount(cost, state.settings.period));
          const periodLabel = PERIOD_LABELS[cost.period] || 'Sin per√≠odo';

          const meta = document.createElement('div');
          meta.className = 'meta';
          const typeChip = document.createElement('span');
          typeChip.className = 'inline-chip';
          typeChip.textContent = cost.type === 'inversion' ? 'Inversi√≥n' : 'Fijo';
          meta.appendChild(typeChip);
          const amountSpan = document.createElement('span');
          amountSpan.textContent = `${amountText} (${periodLabel})`;
          meta.appendChild(amountSpan);
          const amortizationSpan = document.createElement('span');
          amortizationSpan.textContent = amortizationText;
          meta.appendChild(amortizationSpan);
          card.appendChild(meta);

          const groupIds = Array.isArray(cost.groupIds) ? cost.groupIds : [];
          const groups = groupIds.map((id) => state.costGroups.find((group) => group.id === id)).filter(Boolean);
          const chipRow = document.createElement('div');
          chipRow.className = 'group-chip-row';
          if (groups.length) {
            groups.forEach((group) => {
              const chip = document.createElement('span');
              chip.className = 'inline-chip';
              chip.textContent = group.name;
              chipRow.appendChild(chip);
            });
          } else {
            const chip = document.createElement('span');
            chip.className = 'inline-chip';
            chip.textContent = 'Sin grupo';
            chipRow.appendChild(chip);
          }
          card.appendChild(chipRow);

          const equivalence = document.createElement('div');
          equivalence.innerHTML = `Equivale a <strong>${prorated}</strong> por per√≠odo ${activePeriodLabel}.`;
          card.appendChild(equivalence);

          const actions = document.createElement('div');
          actions.className = 'actions';
          const editBtn = document.createElement('button');
          editBtn.className = 'edit';
          editBtn.textContent = 'Editar';
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete';
          deleteBtn.textContent = 'Eliminar';
          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);
          card.appendChild(actions);

          editBtn.addEventListener('click', () => {
            if (activeActionMenuCleanup) {
              activeActionMenuCleanup();
              activeActionMenuCleanup = null;
            }
            openCostModal(cost);
          });
          if (state.activeCostGroupId) {
            deleteBtn.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              if (activeActionMenuCleanup) {
                activeActionMenuCleanup();
              }
              const menu = document.createElement('div');
              menu.className = 'action-menu';
              const removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.textContent = 'Quitar de este grupo';
              const deleteAllBtn = document.createElement('button');
              deleteAllBtn.type = 'button';
              deleteAllBtn.textContent = 'Eliminar costo completamente';
              menu.appendChild(removeBtn);
              menu.appendChild(deleteAllBtn);
              actions.appendChild(menu);

              const cleanup = () => {
                if (menu.parentNode) {
                  menu.parentNode.removeChild(menu);
                }
                document.removeEventListener('click', handleOutsideClick);
                activeActionMenuCleanup = null;
              };

              const handleOutsideClick = (evt) => {
                if (!menu.contains(evt.target) && evt.target !== deleteBtn) {
                  cleanup();
                }
              };

              removeBtn.addEventListener('click', () => {
                cleanup();
                removeCostFromGroup(cost.id, state.activeCostGroupId);
              });
              deleteAllBtn.addEventListener('click', () => {
                cleanup();
                deleteCost(cost.id);
              });

              setTimeout(() => document.addEventListener('click', handleOutsideClick), 0);
              activeActionMenuCleanup = cleanup;
            });
          } else {
            deleteBtn.addEventListener('click', () => deleteCost(cost.id));
          }
          list.appendChild(card);
        });
      }

      function removeCostFromGroup(costId, groupId) {
        if (!groupId) return;
        if (activeActionMenuCleanup) {
          activeActionMenuCleanup();
          activeActionMenuCleanup = null;
        }
        const index = state.costs.findIndex((cost) => cost.id === costId);
        if (index === -1) return;
        const current = state.costs[index];
        const updatedGroups = Array.isArray(current.groupIds) ? current.groupIds.filter((id) => id !== groupId) : [];
        state.costs[index] = Object.assign({}, current, { groupIds: updatedGroups });
        saveState();
        renderCosts();
        updateCostSummary();
        renderResults([]);
        showToast('Costo quitado del grupo');
      }

      function renderGroupControls() {
        if (!elements.costGroupSelect) return;
        if (state.activeCostGroupId && !state.costGroups.some(group => group.id === state.activeCostGroupId)) {
          state.activeCostGroupId = null;
          saveState();
          renderResults([]);
        }
        const current = state.activeCostGroupId || '';
        elements.costGroupSelect.innerHTML = '<option value="">Todos los costos</option>' + state.costGroups.map((group) => `<option value="${group.id}">${group.name}</option>`).join('');
        elements.costGroupSelect.value = current;
        const hasSelection = Boolean(state.activeCostGroupId);
        elements.renameGroupBtn.disabled = !hasSelection;
        elements.deleteGroupBtn.disabled = !hasSelection;
      }

      async function handleCreateGroup() {
        const name = await openPromptModal({
          title: 'Nuevo grupo de costos',
          label: 'Nombre del nuevo grupo de costos',
          placeholder: 'Ej.: Servicios',
          confirmText: 'Crear',
          cancelText: 'Cancelar'
        }); // REPLACED: native dialog ‚Üí internal modal
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) {
          await openAlertModal({
            title: 'Nombre inv√°lido',
            message: 'Ingres√° un nombre v√°lido para el grupo.'
          }); // REPLACED: native dialog ‚Üí internal modal
          return;
        }
        const newGroup = { id: `group_${Date.now()}`, name: trimmed };
        state.costGroups.push(newGroup);
        state.activeCostGroupId = newGroup.id;
        saveState();
        renderGroupControls();
        renderCosts();
        updateCostSummary();
        renderResults([]);
        showToast('Grupo creado');
      }

      async function handleRenameGroup() {
        if (!state.activeCostGroupId) {
          await openAlertModal({
            title: 'Acci√≥n no disponible',
            message: 'Seleccion√° un grupo para renombrar.'
          }); // REPLACED: native dialog ‚Üí internal modal
          return;
        }
        const group = state.costGroups.find(g => g.id === state.activeCostGroupId);
        if (!group) return;
        const name = await openPromptModal({
          title: 'Renombrar grupo',
          label: 'Nuevo nombre del grupo',
          placeholder: 'Ej.: Costos fijos',
          initialValue: group.name,
          confirmText: 'Guardar',
          cancelText: 'Cancelar'
        }); // REPLACED: native dialog ‚Üí internal modal
        if (name === null) return;
        const trimmed = name.trim();
        if (!trimmed) {
          await openAlertModal({
            title: 'Nombre inv√°lido',
            message: 'Ingres√° un nombre v√°lido para el grupo.'
          }); // REPLACED: native dialog ‚Üí internal modal
          return;
        }
        group.name = trimmed;
        saveState();
        renderGroupControls();
        renderCosts();
        showToast('Grupo renombrado');
      }

      async function handleDeleteGroup() {
        if (!state.activeCostGroupId) {
          await openAlertModal({
            title: 'Acci√≥n no disponible',
            message: 'Seleccion√° un grupo para eliminar.'
          }); // REPLACED: native dialog ‚Üí internal modal
          return;
        }
        const group = state.costGroups.find(g => g.id === state.activeCostGroupId);
        if (!group) return;
        const confirmed = await openConfirmModal({
          title: 'Eliminar grupo',
          message: `¬øEliminar el grupo "${group.name}"? Los costos permanecer√°n sin grupo.`,
          confirmText: 'Eliminar',
          cancelText: 'Cancelar'
        }); // REPLACED: native dialog ‚Üí internal modal
        if (!confirmed) return;
        state.costGroups = state.costGroups.filter(g => g.id !== group.id);
        state.costs = state.costs.map((cost) => {
          const currentGroups = Array.isArray(cost.groupIds) ? cost.groupIds.filter((id) => id !== group.id) : [];
          const updated = Object.assign({}, cost, { groupIds: currentGroups });
          delete updated.groupId;
          return updated;
        });
        state.activeCostGroupId = null;
        saveState();
        renderGroupControls();
        renderCosts();
        updateCostSummary();
        renderResults([]);
        showToast('Grupo eliminado');
      }
      function openCostModal(existingCost) {
        const isEdit = Boolean(existingCost);
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        const cost = isEdit ? Object.assign({}, existingCost) : { type: 'fijo', period: 'mensual', amortization: 6, groupIds: state.activeCostGroupId ? [state.activeCostGroupId] : [] };
        if (Array.isArray(cost.groupIds)) {
          cost.groupIds = cost.groupIds.filter((id) => typeof id === 'string' && id);
        } else if (cost.groupId) {
          cost.groupIds = [cost.groupId];
        } else {
          cost.groupIds = [];
        }
        delete cost.groupId;
        cost.period = cost.period || 'mensual';
        overlay.innerHTML = `
          <div class="modal" role="dialog" aria-modal="true">
            <h3>${isEdit ? 'Editar costo' : 'Nuevo costo'}</h3>
            <label>
              <span>Nombre</span>
              <input type="text" id="costName" value="${cost.name || ''}" placeholder="Ej.: Alquiler" />
            </label>
            <label>
              <span>Tipo</span>
              <select type="text" id="costType">
                <option value="fijo" ${cost.type !== 'inversion' ? 'selected' : ''}>Fijo recurrente</option>
                <option value="inversion" ${cost.type === 'inversion' ? 'selected' : ''}>Inversi√≥n amortizable</option>
              </select>
            </label>
            <label>
              <span>Monto ($)</span>
              <input type="number" id="costAmount" min="0" step="0.01" value="${cost.amount || ''}" />
            </label>
            <label>
              <span>Per√≠odo base</span>
              <select id="costPeriod">
                <option value="diario" ${cost.period === 'diario' ? 'selected' : ''}>Diario</option>
                <option value="semanal" ${cost.period === 'semanal' ? 'selected' : ''}>Semanal</option>
                <option value="mensual" ${cost.period === 'mensual' ? 'selected' : ''}>Mensual</option>
                <option value="anual" ${cost.period === 'anual' ? 'selected' : ''}>Anual</option>
              </select>
            </label>
            <div>
              <span style="display:block; font-size:0.9rem; font-weight:600; color: var(--muted-text);">Grupos de costos</span>
              <div id="costGroupCheckboxes" class="checkbox-list"></div>
            </div>
            <label id="amortizationRow" style="display:${cost.type === 'inversion' ? 'block' : 'none'};">
              <span>Plazo de amortizaci√≥n (en per√≠odos)</span>
              <input type="number" id="costAmortization" min="1" step="1" value="${cost.amortization || 6}" />
            </label>
            <div class="modal-actions">
              <button class="cancel">Cancelar</button>
              <button class="confirm">Guardar</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
        const inputs = {
          name: overlay.querySelector('#costName'),
          type: overlay.querySelector('#costType'),
          amount: overlay.querySelector('#costAmount'),
          period: overlay.querySelector('#costPeriod'),
          amortization: overlay.querySelector('#costAmortization'),
          amortizationRow: overlay.querySelector('#amortizationRow'),
          groupContainer: overlay.querySelector('#costGroupCheckboxes')
        };
        inputs.type.addEventListener('change', () => {
          inputs.amortizationRow.style.display = inputs.type.value === 'inversion' ? 'block' : 'none';
        });
        if (inputs.groupContainer) {
          inputs.groupContainer.innerHTML = '';
          if (!state.costGroups.length) {
            const note = document.createElement('div');
            note.className = 'modal-message';
            note.style.margin = '0';
            note.textContent = 'A√∫n no creaste grupos. Pod√©s guardar el costo sin asignarlo.';
            inputs.groupContainer.appendChild(note);
          } else {
            state.costGroups.forEach((group) => {
              const label = document.createElement('label');
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.value = group.id;
              checkbox.checked = cost.groupIds.includes(group.id);
              label.appendChild(checkbox);
              const span = document.createElement('span');
              span.textContent = group.name;
              label.appendChild(span);
              inputs.groupContainer.appendChild(label);
            });
          }
        }
        const close = () => document.body.removeChild(overlay);
        overlay.addEventListener('click', (event) => {
          if (event.target === overlay) close();
        });
        overlay.querySelector('.cancel').addEventListener('click', close);
        overlay.querySelector('.confirm').addEventListener('click', async () => {
          const name = inputs.name.value.trim();
          const amount = parseFloat(inputs.amount.value);
          if (!name) {
            await openAlertModal({
              title: 'Dato requerido',
              message: 'Ingres√° un nombre para el costo.'
            }); // REPLACED: native dialog ‚Üí internal modal
            return;
          }
          if (isNaN(amount) || amount <= 0) {
            await openAlertModal({
              title: 'Monto inv√°lido',
              message: 'Ingres√° un monto v√°lido.'
            }); // REPLACED: native dialog ‚Üí internal modal
            return;
          }
          const selectedGroupIds = inputs.groupContainer ? Array.from(inputs.groupContainer.querySelectorAll('input[type="checkbox"]:checked')).map((checkbox) => checkbox.value) : [];
          const uniqueGroupIds = Array.from(new Set(selectedGroupIds.filter(Boolean)));
          const costData = {
            id: isEdit ? existingCost.id : `cost_${Date.now()}`,
            name,
            type: inputs.type.value,
            amount,
            period: inputs.period.value,
            amortization: inputs.type.value === 'inversion' ? Math.max(1, parseInt(inputs.amortization.value, 10) || 1) : null,
            groupIds: uniqueGroupIds
          };
          if (isEdit) {
            const index = state.costs.findIndex(c => c.id === existingCost.id);
            state.costs[index] = costData;
          } else {
            state.costs.push(costData);
          }
          saveState();
          renderCosts();
          updateCostSummary();
          renderResults([]);
          close();
          showToast('Costo guardado');
        });
      }

      async function deleteCost(id) {
        if (activeActionMenuCleanup) {
          activeActionMenuCleanup();
          activeActionMenuCleanup = null;
        }
        const confirmed = await openConfirmModal({
          title: 'Eliminar costo',
          message: '¬øEliminar este costo?',
          confirmText: 'Eliminar',
          cancelText: 'Cancelar'
        }); // REPLACED: native dialog ‚Üí internal modal
        if (!confirmed) return;
        state.costs = state.costs.filter(c => c.id !== id);
        saveState();
        renderCosts();
        updateCostSummary();
        renderResults([]);
        showToast('Costo eliminado');
      }

      function toggleCostDetailPanel() {
        const panel = elements.costDetailPanel;
        const arrow = elements.costDetailToggle.querySelector('span:last-child');
        const isOpen = panel.classList.toggle('open');
        elements.costDetailToggleLabel.textContent = isOpen ? 'Ocultar detalle por costo' : 'Ver detalle por costo';
        if (arrow) arrow.textContent = isOpen ? '‚ñ≤' : '‚ñº';
      }

      function prorateCostAmount(cost, targetPeriod) {
        const baseAmount = cost.type === 'inversion' ? (cost.amount / (cost.amortization || 1)) : cost.amount;
        const factor = (PERIOD_CONVERSION[cost.period] && PERIOD_CONVERSION[cost.period][targetPeriod]) || 1;
        return baseAmount * factor;
      }

      function calculateTotalCost() {
        const costs = getActiveCosts();
        if (!costs.length) return 0;
        return costs.reduce((acc, cost) => acc + prorateCostAmount(cost, state.settings.period), 0);
      }

      function updateCostSummary() {
        const total = calculateTotalCost();
        const periodLabel = PERIOD_LABELS[state.settings.period] || 'Seleccionado';
        elements.currentPeriodLabel.textContent = periodLabel.toLowerCase();
        elements.totalCostDisplay.textContent = currencyFormatter.format(total);
        updateCapitalOverview(total);
        renderCostDetailPanel();
      }

      function updateCapitalOverview(total) {
        const available = Math.max(0, parseFloat(state.settings.availableCapital) || 0);
        state.settings.availableCapital = available;
        if (elements.availableCapitalInput && document.activeElement !== elements.availableCapitalInput) {
          elements.availableCapitalInput.value = available === 0 ? 0 : available;
        }
        if (elements.availableCapitalDisplay) {
          elements.availableCapitalDisplay.textContent = currencyFormatter.format(available);
        }
        const net = Math.max(0, total - available);
        if (elements.netTargetDisplay) {
          elements.netTargetDisplay.textContent = currencyFormatter.format(net);
        }
        if (elements.capitalCoverageMessage) {
          elements.capitalCoverageMessage.style.display = total > 0 && available >= total ? 'block' : 'none';
        }
      }

      function handleAvailableCapitalChange(event) {
        const raw = typeof event.target.value === 'string' ? event.target.value.replace(',', '.') : event.target.value;
        const parsed = parseFloat(raw);
        const sanitized = Math.max(0, isNaN(parsed) ? 0 : parsed);
        if (event.target.value === '') {
          state.settings.availableCapital = 0;
        } else {
          state.settings.availableCapital = sanitized;
        }
        saveState();
        updateCostSummary();
        renderResults([]);
      }

      function normalizeAvailableCapitalInput() {
        if (!elements.availableCapitalInput) return;
        const rawValue = elements.availableCapitalInput.value;
        const parsed = parseFloat(typeof rawValue === 'string' ? rawValue.replace(',', '.') : rawValue);
        const sanitized = Math.max(0, isNaN(parsed) ? 0 : parsed);
        state.settings.availableCapital = sanitized;
        elements.availableCapitalInput.value = sanitized === 0 ? 0 : sanitized;
        saveState();
        updateCostSummary();
      }

      function renderCostDetailPanel() {
        const panel = elements.costDetailPanel;
        panel.innerHTML = '';
        const costs = getActiveCosts();
        if (!costs.length) {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.textContent = 'Carg√° costos para ver el detalle.';
          panel.appendChild(empty);
          return;
        }
        const total = calculateTotalCost();
        if (!lastResults.length) {
          const hint = document.createElement('div');
          hint.className = 'inline-chip';
          hint.textContent = 'Calcul√° una opci√≥n para estimar la cobertura por costo.';
          panel.appendChild(hint);
        }
        costs.forEach((cost) => {
          const card = document.createElement('div');
          card.className = 'cost-breakdown-card';
          const prorated = prorateCostAmount(cost, state.settings.period);
          const periodLabel = PERIOD_LABELS[cost.period] || 'Sin per√≠odo';
          card.innerHTML = `
            <h4>${cost.name}</h4>
            <div>Monto prorrateado: <strong>${currencyFormatter.format(prorated)}</strong></div>
            <div>Per√≠odo base: ${periodLabel}${cost.type === 'inversion' ? ` ¬∑ Amortiza en ${cost.amortization || 1} per√≠odos` : ''}</div>
          `;
          if (lastResults.length && total > 0) {
            const share = prorated / total;
            const label = document.createElement('div');
            label.style.marginTop = '12px';
            label.style.fontWeight = '600';
            label.style.color = 'var(--muted-text)';
            label.textContent = 'Cobertura estimada usando el √∫ltimo c√°lculo:';
            const list = document.createElement('ul');
            list.style.listStyle = 'none';
            list.style.padding = '0';
            list.style.margin = '8px 0 0';
            list.style.flexDirection = 'column';
            list.style.gap = '6px';
            lastResults[0].items.forEach((item) => {
              const units = item.units * share;
              const boxes = units / item.product.unitsPerBox;
              const li = document.createElement('li');
              li.textContent = `${item.product.name}: ${formatUnits(units)} u (${formatBoxes(boxes)} cajas)`;
              list.appendChild(li);
            });
            card.appendChild(label);
            card.appendChild(list);
          }
          panel.appendChild(card);
        });
      }

      function updateModeButtons() {
        document.querySelectorAll('.mode-selector button').forEach((button) => {
          button.classList.toggle('active', button.dataset.mode === state.settings.mode);
        });
      }

      function updateModePanels() {
        document.querySelectorAll('.mode-panel').forEach((panel) => {
          panel.classList.toggle('active', panel.dataset.panel === state.settings.mode);
        });
      }

      function handleSingleCalculation() {
        state.settings.mode = 'single';
        updateModeButtons();
        updateModePanels();
        const product = state.products.find(p => p.id === state.settings.selectedSkuId) || state.products[0];
        if (!product) return;
        const mix = { [product.id]: 1 };
        const result = buildResultFromMix(`Producto √∫nico ¬∑ ${product.name}`, mix);
        renderResults([result]);
      }

      function handleMixCalculation() {
        state.settings.mode = 'mix';
        updateModeButtons();
        updateModePanels();
        const mix = {};
        state.products.forEach((product) => {
          const pct = state.settings.mix[product.id] || 0;
          if (pct > 0) {
            mix[product.id] = pct / 100;
          }
        });
        const result = buildResultFromMix('Mix manual', mix);
        renderResults([result]);
      }

      function handleGenerateOptions() {
        state.settings.mode = 'auto';
        updateModeButtons();
        updateModePanels();
        const combos = buildAutomaticCombinations();
        const results = combos.map((combo) => buildResultFromMix(combo.title, combo.mix));
        renderResults(results);
      }

      function buildAutomaticCombinations() {
        const enriched = state.products.map((product) => {
          const pricing = buildPricing(product);
          const marginUnit = pricing.netUnit - pricing.costUnit;
          return { product, pricing, marginUnit };
        });
        const byMargin = [...enriched].sort((a, b) => (b.marginUnit - a.marginUnit));
        const byPrice = [...enriched].sort((a, b) => (a.pricing.priceUnit - b.pricing.priceUnit));
        const combos = [];
        const usedLetters = new Set();
        const nextLetter = () => {
          let code = 65;
          while (usedLetters.has(String.fromCharCode(code))) {
            code += 1;
          }
          return String.fromCharCode(code);
        };
        const pushCombo = (letter, description, mix) => {
          if (!mix) return;
          const letterToUse = letter || nextLetter();
          combos.push({ title: `Opci√≥n ${letterToUse} ¬∑ ${description}`, mix });
          usedLetters.add(letterToUse);
        };
        if (byMargin[0]) {
          pushCombo('A', 'Mayor margen', buildMixObject([{ entry: byMargin[0], pct: 1 }]));
        }
        if (byPrice[0]) {
          pushCombo('B', 'Menor precio final', buildMixObject([{ entry: byPrice[0], pct: 1 }]));
        }
        if (byMargin[0]) {
          const second = byMargin[1] || byMargin[0];
          pushCombo('C', '50/50 mejores m√°rgenes', buildMixObject([{ entry: byMargin[0], pct: 0.5 }, { entry: second, pct: 0.5 }]));
        }
        const equalSlice = byMargin.slice(0, Math.min(4, enriched.length));
        if (equalSlice.length) {
          const pct = 1 / equalSlice.length;
          pushCombo('D', 'Mix equilibrado', buildMixObject(equalSlice.map(entry => ({ entry, pct }))));
        }
        if (byMargin[0]) {
          const third = byMargin[2] || byMargin[1] || byMargin[0];
          const fourth = byMargin[3] || third;
          pushCombo('E', 'Foco en margen + complemento', buildMixObject([{ entry: byMargin[0], pct: 0.6 }, { entry: third, pct: 0.2 }, { entry: fourth, pct: 0.2 }]));
        }
        if (byMargin.length) {
          const topThree = [byMargin[0], byMargin[1] || byMargin[0], byMargin[2] || byMargin[1] || byMargin[0]];
          pushCombo('F', 'Top 3 escalonado', buildMixObject([{ entry: topThree[0], pct: 0.5 }, { entry: topThree[1], pct: 0.3 }, { entry: topThree[2], pct: 0.2 }]));
        }
        if (byPrice.length > 1) {
          pushCombo('G', 'Precio competitivo', buildMixObject([{ entry: byPrice[0], pct: 0.6 }, { entry: byPrice[1], pct: 0.4 }]));
        }
        if (enriched.length) {
          const pct = 1 / enriched.length;
          pushCombo('H', 'Diversificaci√≥n total', buildMixObject(enriched.map(entry => ({ entry, pct }))));
        }
        while (combos.length < 8 && enriched.length) {
          const next = enriched[combos.length % enriched.length];
          pushCombo(null, 'Alternativa', buildMixObject([{ entry: next, pct: 1 }]));
        }
        return combos.slice(0, 8);
      }

      function buildMixObject(definitions) {
        const totals = {};
        definitions.forEach((def) => {
          if (!def || !def.entry) return;
          const id = def.entry.product.id;
          totals[id] = (totals[id] || 0) + def.pct;
        });
        const sum = Object.values(totals).reduce((acc, val) => acc + val, 0) || 1;
        const normalized = {};
        Object.keys(totals).forEach((id) => {
          normalized[id] = totals[id] / sum;
        });
        return normalized;
      }

      function buildResultFromMix(title, mixMap) {
        const activeCosts = getActiveCosts();
        if (!activeCosts.length) {
          return { title, error: 'Carg√° costos para poder calcular.' };
        }
        const entries = Object.keys(mixMap || {}).map((id) => {
          const product = state.products.find(p => p.id === id);
          if (!product) return null;
          const fraction = mixMap[id];
          const pricing = buildPricing(product);
          const marginUnit = pricing.netUnit - pricing.costUnit;
          return { product, fraction, pricing, marginUnit };
        }).filter(Boolean);
        if (!entries.length) {
          return { title, error: 'No hay productos seleccionados en esta combinaci√≥n.' };
        }
        const totalFraction = entries.reduce((acc, entry) => acc + entry.fraction, 0);
        if (totalFraction <= 0) {
          return { title, error: 'La combinaci√≥n no es v√°lida.' };
        }
        entries.forEach((entry) => { entry.fraction = entry.fraction / totalFraction; });
        const grossTarget = calculateTotalCost();
        const availableCapital = Math.max(0, parseFloat(state.settings.availableCapital) || 0);
        const targetBase = Math.max(0, grossTarget - availableCapital);
        if (targetBase <= 0) {
          return { title, message: 'Objetivo cubierto: no se requieren ventas', items: [], totalRevenue: 0, totalRevenueExact: 0, totalRevenueReal: 0, goalAmount: 0, baseCost: 0, warnings: [], totalUnits: 0, totalUnitsExact: 0, totalUnitsReal: 0 };
        }
        const marginSum = entries.reduce((acc, entry) => acc + (entry.marginUnit * entry.fraction), 0);
        if (marginSum <= 0) {
          return { title, error: 'La combinaci√≥n no es viable: margen neto no positivo.' };
        }
        const totalUnits = targetBase / marginSum;
        const items = entries.map((entry) => {
          const units = totalUnits * entry.fraction;
          const boxes = units / entry.product.unitsPerBox;
          const roundedBoxes = Math.ceil(boxes);
          const roundedUnits = roundedBoxes * entry.product.unitsPerBox;
          const marginPct = entry.pricing.netUnit > 0 ? (entry.marginUnit / entry.pricing.netUnit) : 0;
          const minWarning = units < entry.product.minUnits;
          return {
            product: entry.product,
            units,
            boxes,
            roundedUnits,
            roundedBoxes,
            pricing: entry.pricing,
            marginUnit: entry.marginUnit,
            marginPct,
            minWarning
          };
        });
        const totalRevenue = items.reduce((acc, item) => acc + (item.units * item.pricing.priceUnit), 0);
        const totalRevenueReal = items.reduce((acc, item) => acc + (item.roundedUnits * item.pricing.priceUnit), 0);
        const totalUnitsReal = items.reduce((acc, item) => acc + item.roundedUnits, 0);
        const warnings = [];
        items.forEach((item) => {
          if (item.marginPct < 0.35) {
            warnings.push(`‚ö†Ô∏è ${item.product.name}: margen ${numberFormatter.format(item.marginPct * 100)}% por debajo del 35%.`);
          }
          if (item.minWarning) {
            const minInfo = item.product.unitsPerBox === 50 ? '2 cajas de 50 (100 u)' : '1 caja de 100 u';
            warnings.push(`‚ö†Ô∏è ${item.product.name}: el m√≠nimo operativo es 100 u (${minInfo}).`);
          }
        });
        const result = {
          title,
          items,
          totalRevenue,
          totalRevenueExact: totalRevenue,
          totalRevenueReal,
          goalAmount: targetBase,
          baseCost: targetBase,
          warnings,
          totalUnits,
          totalUnitsExact: totalUnits,
          totalUnitsReal,
          mixMap
        };
        result.copyText = buildCopyText(result);
        return result;
      }

      function buildCopyText(result) {
        const lines = [];
        lines.push(`Opci√≥n: ${result.title}`);
        lines.push(`Objetivo a cubrir: ${currencyFormatter.format(result.goalAmount)}`);
        const exact = typeof result.totalRevenueExact === 'number' ? result.totalRevenueExact : result.totalRevenue;
        const real = typeof result.totalRevenueReal === 'number' ? result.totalRevenueReal : exact;
        lines.push(`Facturaci√≥n estimada: ${currencyFormatter.format(exact)}`);
        lines.push(`Facturaci√≥n real: ${currencyFormatter.format(real)}`);
        result.items.forEach((item) => {
          lines.push(`- ${item.product.name}: Real ${formatInteger(item.roundedBoxes)} cajas (${formatInteger(item.roundedUnits)} u) ¬∑ Exacta ${formatBoxes(item.units / item.product.unitsPerBox)} cajas (${formatUnits(item.units)} u)`);
        });
        if (result.warnings && result.warnings.length) {
          lines.push('Alertas:');
          result.warnings.forEach((warning) => lines.push(`  ${warning}`));
        }
        return lines.join('\n');
      }

      function renderResults(results) {
        elements.resultsContainer.innerHTML = '';
        if (!results || !results.length) {
          const message = document.createElement('div');
          message.className = 'empty-state';
          message.textContent = state.costs.length ? 'Eleg√≠ un modo y calcul√° para ver resultados.' : 'Agreg√° costos para comenzar.';
          elements.resultsContainer.appendChild(message);
          lastResults = [];
          renderCostDetailPanel();
          return;
        }
        results.forEach((result, index) => {
          const card = document.createElement('div');
          card.className = 'result-card';
          const title = document.createElement('h3');
          title.textContent = result.title || `Resultado ${index + 1}`;
          card.appendChild(title);
          if (result.error) {
            const error = document.createElement('div');
            error.className = 'alert';
            error.textContent = result.error;
            card.appendChild(error);
          } else {
            const body = document.createElement('div');
            body.className = 'result-body';
            if (result.items && result.items.length) {
              const list = document.createElement('ul');
              result.items.forEach((item) => {
                const li = document.createElement('li');
                li.innerHTML = `
                  <strong>${item.product.name}</strong>
                  <div class="result-quantity">
                    <div class="result-quantity-real">Real: ${formatInteger(item.roundedBoxes)} cajas (${formatInteger(item.roundedUnits)} unidades)</div>
                    <div class="result-quantity-exact">Exacta: ${formatBoxes(item.boxes)} cajas (${formatUnits(item.units)} unidades)</div>
                  </div>
                `;
                list.appendChild(li);
              });
              body.appendChild(list);
            }
            if (result.message) {
              const info = document.createElement('div');
              info.className = 'empty-state';
              info.textContent = result.message;
              body.appendChild(info);
            }
            const footer = document.createElement('div');
            footer.className = 'result-footer';
            if (typeof result.goalAmount === 'number') {
              const goal = document.createElement('div');
              goal.innerHTML = `<strong>Objetivo a cubrir:</strong> ${currencyFormatter.format(result.goalAmount)}`;
              footer.appendChild(goal);
            }
            if (typeof result.totalRevenueExact === 'number' || typeof result.totalRevenue === 'number') {
              const revenue = document.createElement('div');
              const exact = typeof result.totalRevenueExact === 'number' ? result.totalRevenueExact : result.totalRevenue;
              revenue.innerHTML = `<strong>Facturaci√≥n estimada:</strong> ${currencyFormatter.format(exact)}`;
              footer.appendChild(revenue);
            }
            if (typeof result.totalRevenueReal === 'number') {
              const revenueReal = document.createElement('div');
              revenueReal.innerHTML = `<strong>Facturaci√≥n real:</strong> ${currencyFormatter.format(result.totalRevenueReal)}`;
              footer.appendChild(revenueReal);
            }
            if (result.items && result.items.length) {
              const copyBtn = document.createElement('button');
              copyBtn.textContent = 'Copiar resultado';
              copyBtn.addEventListener('click', () => copyResult(result));
              footer.appendChild(copyBtn);
            }
            if (result.warnings && result.warnings.length) {
              const warningBlock = document.createElement('div');
              warningBlock.className = 'warnings';
              result.warnings.forEach((warning) => {
                const span = document.createElement('span');
                span.textContent = warning;
                warningBlock.appendChild(span);
              });
              footer.appendChild(warningBlock);
            }
            body.appendChild(footer);
            card.appendChild(body);
          }
          elements.resultsContainer.appendChild(card);
        });
        lastResults = results.filter((result) => !result.error && result.items && result.items.length);
        renderCostDetailPanel();
      }

      async function copyResult(result) {
        const text = result.copyText || buildCopyText(result);
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(text);
            showToast('Resultado copiado');
          } catch (error) {
            await fallbackCopy(text);
          }
        } else {
          await fallbackCopy(text);
        }
      }

      async function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          showToast('Resultado copiado');
        } catch (error) {
          await openAlertModal({
            title: 'Copi√° el texto manualmente',
            message: 'No se pudo copiar autom√°ticamente, copi√° el texto manualmente.'
          }); // REPLACED: native dialog ‚Üí internal modal
        }
        document.body.removeChild(textarea);
      }

      function formatUnits(value) {
        return numberFormatter.format(value);
      }

      function formatBoxes(value) {
        return numberFormatter.format(value);
      }

      function formatInteger(value) {
        return integerFormatter.format(value || 0);
      }

      function showToast(message) {
        elements.toast.textContent = message;
        elements.toast.classList.add('show');
        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
          elements.toast.classList.remove('show');
        }, 2600);
      }

      window.addEventListener('beforeunload', saveState);
      // --- ROI Calculator & Navigation Logic ---

      function initApp() {
        // Bind Menu Events
        document.getElementById('btnOpenCostApp').addEventListener('click', () => switchApp('cost'));
        document.getElementById('btnOpenRoiApp').addEventListener('click', () => switchApp('roi'));
        document.getElementById('backToMenuFromCost').addEventListener('click', () => switchApp('menu'));
        document.getElementById('backToMenuFromRoi').addEventListener('click', () => switchApp('menu'));

        // Init Cost App (Original)
        init();

        // Init ROI App
        initRoiApp();
      }

      function switchApp(target) {
        const menu = document.getElementById('main-menu');
        const costApp = document.getElementById('cost-app');
        const roiApp = document.getElementById('roi-app');
        const productsSection = document.getElementById('productsSection');

        menu.style.display = 'none';
        costApp.style.display = 'none';
        roiApp.style.display = 'none';

        // Products section is inside menu by default structure, but we might want to show/hide it
        // Actually, since it's a child of #main-menu, hiding #main-menu hides it.
        // But we want it visible in Cost App too.
        // Solution: Move it in DOM? Or just clone it? 
        // Better: Just toggle visibility.
        // Wait, if it's inside #main-menu div, I can't show it without showing the menu buttons if they are siblings.
        // Let's do this: When in Cost App, we SHOW #main-menu but HIDE the .menu-grid (buttons).
        // When in ROI App, we HIDE #main-menu completely.

        const menuGrid = document.querySelector('.menu-grid');
        const menuTitle = document.querySelector('#main-menu h1');

        if (target === 'menu') {
          menu.style.display = 'flex';
          menuGrid.style.display = 'grid';
          menuTitle.style.display = 'block';
          productsSection.style.display = 'block';
          window.scrollTo(0, 0);
        } else if (target === 'cost') {
          // Cost App Mode: Hide products section
          menu.style.display = 'none';
          costApp.style.display = 'flex';
          window.scrollTo(0, 0);
        } else if (target === 'roi') {
          // ROI App Mode: Hide everything related to Cost App/Menu
          menu.style.display = 'none';
          roiApp.style.display = 'flex';
          window.scrollTo(0, 0);

          // Render inputs for Real Mode
          renderRoiProductInputs();
        }
      }

      // Initialize Menu Navigation
      document.getElementById('btnOpenCostApp').addEventListener('click', () => switchApp('cost'));
      document.getElementById('btnOpenRoiApp').addEventListener('click', () => switchApp('roi'));
      document.getElementById('backToMenuFromCost').addEventListener('click', () => switchApp('menu'));
      document.getElementById('backToMenuFromRoi').addEventListener('click', () => switchApp('menu'));

      // Initialize Product Management
      document.getElementById('addProductBtn').addEventListener('click', () => openProductModal());


      function renderRoiProductInputs() {
        const container = document.getElementById('roiProductInputs');
        if (!container) return;
        container.innerHTML = '';

        state.products.forEach(product => {
          const card = document.createElement('div');
          card.className = 'parameter-card';
          card.innerHTML = `
            <label>
              <span>${product.name}</span>
              <input 
                type="number" 
                class="roi-product-qty" 
                data-id="${product.id}" 
                min="0" 
                step="0.1" 
                placeholder="Ej: 3.5" 
              />
            </label>
            <small style="color: var(--muted-text); font-size: 0.85rem; margin-top: -8px; display: block;">
              Precio: ${currencyFormatter.format(product.pricePer100)} | Costo: ${currencyFormatter.format(product.costPer100)}
            </small>
            <div class="roi-breakdown" id="breakdown-${product.id}" style="margin-top: 8px; font-size: 0.85rem; color: var(--text-color); background: rgba(0,0,0,0.03); padding: 8px; border-radius: 8px; display: none;">
              <div style="display: flex; justify-content: space-between;"><span>Facturado:</span> <strong class="val-revenue">$0</strong></div>
              <div style="display: flex; justify-content: space-between;"><span>Costo:</span> <strong class="val-cost">$0</strong></div>
              <div style="display: flex; justify-content: space-between; margin-top: 4px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 4px;"><span>Ganancia:</span> <strong class="val-profit" style="color: var(--accent-dark);">$0</strong></div>
            </div>
          `;

          const input = card.querySelector('input');
          const breakdown = card.querySelector('.roi-breakdown');
          const valRevenue = breakdown.querySelector('.val-revenue');
          const valCost = breakdown.querySelector('.val-cost');
          const valProfit = breakdown.querySelector('.val-profit');

          input.addEventListener('input', () => {
            const qty = parseFloat(input.value) || 0;
            if (qty > 0) {
              breakdown.style.display = 'block';

              // Calculate based on product type (50u vs 100u)
              const is50Unit = product.name.toLowerCase().includes('50u') || product.name.toLowerCase().includes('50 uni');
              const price = is50Unit ? product.pricePer100 / 2 : product.pricePer100;
              const cost = is50Unit ? product.costPer100 / 2 : product.costPer100;

              const revenue = qty * price;
              const cogs = qty * cost;
              const profit = revenue - cogs;

              valRevenue.textContent = currencyFormatter.format(revenue);
              valCost.textContent = currencyFormatter.format(cogs);
              valProfit.textContent = currencyFormatter.format(profit);
              valProfit.style.color = profit >= 0 ? '#4c8256' : '#b33727';
            } else {
              breakdown.style.display = 'none';
            }
          });

          container.appendChild(card);
        });
      }

      function initRoiApp() {
        const ROI_STORAGE_KEY = 'roi_app_state_v1';
        let currentMode = 'real'; // Default to real

        const roiInputs = {
          budget: document.getElementById('roiBudget'),
          cpm: document.getElementById('roiCpm'),
          ctr: document.getElementById('roiCtr'),
          convRate: document.getElementById('roiConvRate'),
          aov: document.getElementById('roiAov'),
          margin: document.getElementById('roiMargin'), // Added margin input
          // Real inputs
          realBudget: document.getElementById('roiRealBudget')
        };

        const roiOutputs = {
          section: document.getElementById('roiResultsSection'),
          cardFunnel: document.getElementById('cardFunnel'),
          cardSales: document.getElementById('cardSales'),
          impressions: document.getElementById('resImpressions'),
          clicks: document.getElementById('resClicks'),
          cpc: document.getElementById('resCpc'),
          conversions: document.getElementById('resConversions'),
          cpa: document.getElementById('resCpa'),
          globalConv: document.getElementById('resGlobalConv'),
          revenue: document.getElementById('resRevenue'),
          adCost: document.getElementById('resAdCost'),
          cogs: document.getElementById('resCogs'),
          profit: document.getElementById('resProfit'),
          roas: document.getElementById('resRoas'),
          roi: document.getElementById('resRoi')
        };

        // Tabs Logic
        const tabs = document.querySelectorAll('.roi-tab-btn');
        const projectionPanel = document.getElementById('roiProjectionInputs');
        const realPanel = document.getElementById('roiRealInputs');

        // Set initial display based on default mode
        if (currentMode === 'projection') {
          projectionPanel.style.display = 'block';
          realPanel.style.display = 'none';
        } else {
          projectionPanel.style.display = 'none';
          realPanel.style.display = 'block';
        }
        // Set active tab button
        const initialTab = document.querySelector(`.roi-tab-btn[data-tab="${currentMode}"]`);
        if (initialTab) initialTab.classList.add('active');


        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentMode = tab.dataset.tab;

            if (currentMode === 'projection') {
              projectionPanel.style.display = 'block';
              realPanel.style.display = 'none';
            } else {
              projectionPanel.style.display = 'none';
              realPanel.style.display = 'block';
            }
            // Hide results when switching modes to avoid confusion
            roiOutputs.section.style.display = 'none';
          });
        });

        // Load State
        try {
          const saved = localStorage.getItem(ROI_STORAGE_KEY);
          if (saved) {
            const data = JSON.parse(saved);
            Object.keys(roiInputs).forEach(key => {
              if (data[key] !== undefined && roiInputs[key]) roiInputs[key].value = data[key];
            });
            // Restore mode if saved
            if (data.mode) {
              currentMode = data.mode;
              const tab = document.querySelector(`.roi-tab-btn[data-tab="${data.mode}"]`);
              if (tab) {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
              }
              if (currentMode === 'projection') {
                projectionPanel.style.display = 'block';
                realPanel.style.display = 'none';
              } else {
                projectionPanel.style.display = 'none';
                realPanel.style.display = 'block';
              }
            }
          }
        } catch (e) {
          console.error('Error loading ROI state', e);
        }

        // Bind Events
        document.getElementById('calculateRoiBtn').addEventListener('click', calculateRoi);
        document.getElementById('resetRoiBtn').addEventListener('click', () => {
          Object.values(roiInputs).forEach(input => { if (input) input.value = ''; });
          roiOutputs.section.style.display = 'none';
          localStorage.removeItem(ROI_STORAGE_KEY);
          showToast('C√°lculo reseteado');
        });

        function calculateRoi() {
          const values = {};
          let valid = true;

          // Validate based on mode
          const keysToValidate = currentMode === 'projection'
            ? ['budget', 'cpm', 'ctr', 'convRate', 'aov', 'margin']
            : ['realBudget'];

          keysToValidate.forEach(key => {
            const val = parseFloat(roiInputs[key].value);
            if (isNaN(val) || val < 0) valid = false;
            values[key] = val;
          });

          if (!valid) {
            showToast('Por favor complet√° todos los campos con valores v√°lidos');
            return;
          }

          // Save State
          const allValues = { mode: currentMode };
          Object.keys(roiInputs).forEach(key => {
            if (roiInputs[key]) allValues[key] = roiInputs[key].value;
          });
          localStorage.setItem(ROI_STORAGE_KEY, JSON.stringify(allValues));

          let budget, revenue, costOfGoods, profit, roas, roi;
          let impressions = 0, clicks = 0, cpc = 0, conversions = 0, cpa = 0;

          if (currentMode === 'projection') {
            budget = values.budget;
            const margin = values.margin;

            // Funnel Calcs
            impressions = budget / (values.cpm / 1000);
            clicks = impressions * (values.ctr / 100);
            cpc = clicks > 0 ? budget / clicks : 0;
            conversions = clicks * (values.convRate / 100);
            cpa = conversions > 0 ? budget / conversions : 0;
            revenue = conversions * values.aov;

            costOfGoods = revenue * (1 - (margin / 100));
            profit = revenue - budget - costOfGoods;

            // Show Funnel Cards
            roiOutputs.cardFunnel.style.display = 'flex';
            roiOutputs.cardSales.style.display = 'flex';

            // Render Funnel
            roiOutputs.impressions.textContent = formatInteger(impressions);
            roiOutputs.clicks.textContent = formatInteger(clicks);
            roiOutputs.cpc.textContent = currencyFormatter.format(cpc);
            roiOutputs.conversions.textContent = formatInteger(conversions);
            roiOutputs.cpa.textContent = currencyFormatter.format(cpa);
            roiOutputs.globalConv.textContent = values.convRate + '%';

          } else {
            // Real Mode - Product-based calculation
            budget = values.realBudget;

            // Calculate Revenue and COGS based on products sold
            revenue = 0;
            costOfGoods = 0;
            const productInputs = document.querySelectorAll('.roi-product-qty');

            productInputs.forEach(input => {
              const qty = parseFloat(input.value) || 0;
              if (qty > 0) {
                const pid = input.dataset.id;
                const product = state.products.find(p => p.id === pid);

                if (product) {
                  // Check if it's a 50-unit product (special case: price/2)
                  const is50Unit = product.name.toLowerCase().includes('50u');

                  if (is50Unit) {
                    // For 50u products: divide price and cost by 2
                    revenue += qty * (product.pricePer100 / 2);
                    costOfGoods += qty * (product.costPer100 / 2);
                  } else {
                    // For regular 100u products
                    revenue += qty * product.pricePer100;
                    costOfGoods += qty * product.costPer100;
                  }
                }
              }
            });

            profit = revenue - budget - costOfGoods;

            // Hide Funnel Cards
            roiOutputs.cardFunnel.style.display = 'none';
            roiOutputs.cardSales.style.display = 'none';

            // Clear projection-specific outputs
            roiOutputs.impressions.textContent = '-';
            roiOutputs.clicks.textContent = '-';
            roiOutputs.cpc.textContent = '-';
            roiOutputs.conversions.textContent = '-';
            roiOutputs.cpa.textContent = '-';
            roiOutputs.globalConv.textContent = '-';
          }

          // Common Metrics
          roas = budget > 0 ? revenue / budget : 0;
          const totalInvestment = budget + costOfGoods;
          roi = totalInvestment > 0 ? (profit / totalInvestment) * 100 : 0;

          // Render Financials
          roiOutputs.revenue.textContent = currencyFormatter.format(revenue);
          roiOutputs.adCost.textContent = currencyFormatter.format(budget);
          roiOutputs.cogs.textContent = currencyFormatter.format(costOfGoods);
          roiOutputs.profit.textContent = currencyFormatter.format(profit);

          roiOutputs.roas.textContent = numberFormatter.format(roas) + 'x';
          roiOutputs.roi.textContent = numberFormatter.format(roi) + '%';

          // Colorize Profit/ROI
          roiOutputs.profit.style.color = profit >= 0 ? '#4c8256' : '#b33727';
          roiOutputs.roi.style.color = roi >= 0 ? 'white' : '#ffcccb';

          roiOutputs.section.style.display = 'block';

          setTimeout(() => {
            roiOutputs.section.scrollIntoView({ behavior: 'smooth' });
          }, 100);
        }
      }
    })();
  </script>
</body>

</html>